<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>客客帮文档库</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f9fbfd;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #333;
            line-height: 1.5;
        }

        .container {
            text-align: center;
            padding: 24px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            max-width: 700px;
            width: 92%;
            margin: 16px;
        }

        h2 {
            margin: 0 0 16px;
            color: #2c3e50;
            font-size: 22px;
        }

        #readme-area {
            text-align: left;
            padding: 16px;
            background: #fafafa;
            border-radius: 8px;
            min-height: 40px;
            max-height: 220px;
            overflow-y: auto;
            margin: 16px 0;
            font-size: 15px;
            color: #444;
            line-height: 1.6;
        }

        /* Markdown 样式 */
        #readme-area h1,
        #readme-area h2,
        #readme-area h3 {
            margin: 14px 0 10px;
            color: #2c3e50;
        }

        #readme-area strong {
            font-weight: 600;
        }

        #readme-area ul,
        #readme-area ol {
            padding-left: 24px;
            margin: 10px 0;
        }

        #readme-area li {
            margin: 6px 0;
        }

        #readme-area p {
            margin: 10px 0;
        }

        .confirm-btn {
            margin-top: 12px;
            padding: 10px 24px;
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .confirm-btn:hover:not(:disabled) {
            background-color: #27ae60;
        }

        .confirm-btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        .error-container {
            display: none;
        }

        .debug-section {
            margin-top: 20px;
            padding: 14px;
            background: #f8f9fa;
            border: 1px solid #eee;
            border-radius: 8px;
            font-size: 13px;
            text-align: left;
            color: #666;
        }

        .debug-section h4 {
            margin-top: 0;
            color: #777;
            font-size: 15px;
            border-bottom: 1px dashed #ddd;
            padding-bottom: 6px;
        }

        .debug-line {
            margin: 4px 0;
        }

        .label {
            font-weight: bold;
            color: #333;
            display: inline-block;
            width: 60px;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px 16px;
            }
            h2 {
                font-size: 20px;
            }
            #readme-area {
                font-size: 14px;
                padding: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="main-container">
        <h2>客客帮文档库</h2>
        <div id="readme-area">加载中...</div>
        <button id="confirm-btn" class="confirm-btn" style="display: none;" onclick="startRedirect()">我已阅读，继续跳转</button>
    </div>

    <div class="container error-container" id="error-container">
        <h2>⚠️ 跳转失败</h2>
        <p>未能成功跳转到目标页面，请检查网络或稍后重试。</p>
        <button class="confirm-btn" onclick="location.reload()">点击重试</button>

        <div class="debug-section">
            <h4>调试信息</h4>
            <div class="debug-line"><span class="label">时间：</span><span id="debug-time"></span></div>
            <div class="debug-line"><span class="label">地址：</span><span id="debug-url"></span></div>
            <div class="debug-line"><span class="label">错误：</span><span id="debug-error"></span></div>
        </div>
    </div>

    <script>
        let redirectAttempted = false;
        const txtUrl = "https://o.nmgjg.com.cn/wiki.txt";
        const readmeUrl = "https://o.nmgjg.com.cn/wiki_readme.md";

        // 简单 Markdown 渲染
        function simpleMarkdown(text) {
            let html = text
                .replace(/\r\n/g, '\n')
                .replace(/\n{3,}/g, '\n\n')
                .split('\n');

            let inList = false;
            let listType = '';
            let result = [];

            for (let line of html) {
                line = line.trim();

                const ulMatch = line.match(/^[-*+]\s+(.*)/);
                const olMatch = line.match(/^(\d+)\.\s+(.*)/);
                const headingMatch = line.match(/^(#{1,3})\s+(.*)/);

                if (headingMatch) {
                    const level = headingMatch[1].length;
                    result.push(`<h${level}>${escapeHtml(headingMatch[2])}</h${level}>`);
                    inList = false;
                } else if (ulMatch) {
                    if (!inList || listType !== 'ul') {
                        if (inList) result.push(`</${listType}>`);
                        result.push('<ul>');
                        inList = true;
                        listType = 'ul';
                    }
                    result.push(`<li>${formatInline(ulMatch[1])}</li>`);
                } else if (olMatch) {
                    if (!inList || listType !== 'ol') {
                        if (inList) result.push(`</${listType}>`);
                        result.push('<ol>');
                        inList = true;
                        listType = 'ol';
                    }
                    result.push(`<li>${formatInline(olMatch[2])}</li>`);
                } else {
                    if (inList) {
                        result.push(`</${listType}>`);
                        inList = false;
                    }
                    if (line === '') {
                        result.push('<p></p>');
                    } else {
                        result.push(`<p>${formatInline(line)}</p>`);
                    }
                }
            }

            if (inList) result.push(`</${listType}>`);

            return result.join('\n');
        }

        function formatInline(str) {
            return escapeHtml(str)
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '<',
                '>': '>',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // 获取要跳转的路径
        function getTargetPath() {
            const urlParams = new URLSearchParams(window.location.search);
            let path = urlParams.get('url');
            if (path !== null) {
                // 确保以 / 开头
                if (!path.startsWith('/')) path = '/' + path;
                return path;
            }
            // 否则使用当前路径
            return window.location.pathname;
        }

        // 页面加载
        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("debug-time").textContent = new Date().toLocaleString('zh-CN');
            document.getElementById("debug-url").textContent = window.location.href;

            const urlParams = new URLSearchParams(window.location.search);
            const hasUrlParam = urlParams.has('url');

            // 无论有没有 url 参数，都先尝试加载 README（除非你希望有 url 参数时跳过 README？）
            // 根据你之前要求：“文档说明加载页面就不必了” + “有 url 参数直接跳转” → 但注意：现在不能直接跳转！
            // 因为必须先读 wiki.txt 才知道域名！
            // 所以：即使有 url 参数，也必须走 redirect 流程，但可以跳过 README 显示。

            if (hasUrlParam) {
                // 有 url 参数：跳过 README，直接开始跳转流程
                startRedirect();
            } else {
                // 无 url 参数：显示 README
                fetch(readmeUrl, { cache: "no-cache" })
                    .then(response => {
                        if (!response.ok) throw new Error('README 加载失败');
                        return response.text();
                    })
                    .then(text => {
                        const html = simpleMarkdown(text);
                        document.getElementById("readme-area").innerHTML = html;
                        document.getElementById("confirm-btn").style.display = "inline-block";
                    })
                    .catch(() => {
                        // README 失败 → 直接跳转
                        startRedirect();
                    });
            }
        });

        function startRedirect() {
            const btn = document.getElementById("confirm-btn");
            if (btn.style.display !== "none") {
                btn.disabled = true;
                btn.textContent = "跳转中...";
            } else {
                document.getElementById("readme-area").textContent = "跳转中...";
            }

            fetch(txtUrl, { cache: "no-cache" })
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.text();
                })
                .then(text => {
                    const ipPort = text.trim();
                    if (!ipPort) throw new Error("IP:Port 为空");

                    const targetPath = getTargetPath(); // 这里会正确获取 ?url=xxx 的值
                    const targetUrl = `http://${ipPort}${targetPath}`;

                    doRedirect(targetUrl);
                })
                .catch(error => {
                    showError(error.toString());
                });
        }

        function doRedirect(url) {
            redirectAttempted = true;
            window.location.href = url;

            setTimeout(() => {
                if (redirectAttempted) {
                    showError("跳转未生效，请检查网络或地址");
                }
            }, 5000);
        }

        function showError(msg) {
            document.getElementById("debug-error").textContent = msg;
            document.getElementById("main-container").style.display = "none";
            document.getElementById("error-container").style.display = "block";
        }
    </script>
</body>
</html>